import React, { useState, useRef } from 'react';
import { Download, Printer, FileSpreadsheet, Plus, Trash2, RefreshCw, Save, Sparkles, X, MessageSquareQuote, CheckCircle2, Upload } from 'lucide-react';

const ResumeDashboard = () => {
  // --- State Management ---
  const [activeTab, setActiveTab] = useState('profile');
  
  // AI related states
  const [showAIModal, setShowAIModal] = useState(false);
  const [aiContent, setAiContent] = useState('');
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [aiModalTitle, setAiModalTitle] = useState('');
  
  const [profile, setProfile] = useState({
    lastName: '',
    firstName: '',
    lastNameKana: '',
    firstNameKana: '',
    birthdayYear: '',
    birthdayMonth: '',
    birthdayDay: '',
    age: '',
    gender: '',
    zip: '',
    address: '',
    addressKana: '',
    foreignAddress: '',
    phone: '',
    email: '',
    photo: null
  });

  // Split history into educations and works
  const [educations, setEducations] = useState([
    { id: 1, year: '', month: '', content: '' },
    { id: 2, year: '', month: '', content: '' },
    { id: 3, year: '', month: '', content: '' },
    { id: 4, year: '', month: '', content: '' },
  ]);

  const [works, setWorks] = useState([
    { id: 1, year: '', month: '', content: '' },
    { id: 2, year: '', month: '', content: '' },
    { id: 3, year: '', month: '', content: '' },
    { id: 4, year: '', month: '', content: '' },
  ]);

  const [licenses, setLicenses] = useState([
    { id: 1, year: '', month: '', content: '' },
    { id: 2, year: '', month: '', content: '' },
    { id: 3, year: '', month: '', content: '' },
    { id: 4, year: '', month: '', content: '' },
  ]);

  const [extra, setExtra] = useState({
    motivation: '', // 志望動機など
    commuteTime: '',
    dependents: '',
    spouse: '',
    spouseSupport: ''
  });

  // --- Photo Handlers ---
  const handlePhotoUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setProfile(prev => ({ ...prev, photo: reader.result }));
      };
      reader.readAsDataURL(file);
    }
  };

  const clearPhoto = () => {
    setProfile(prev => ({ ...prev, photo: null }));
  };

  // --- Gemini API Helper ---
  const callGeminiAPI = async (prompt, systemInstruction = "") => {
    const apiKey = ""; // Environment will inject the key
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    const payload = {
      contents: [{ parts: [{ text: prompt }] }],
      systemInstruction: { parts: [{ text: systemInstruction }] }
    };

    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        throw new Error(`API Error: ${response.status}`);
      }

      const data = await response.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || "申し訳ありません。生成に失敗しました。";
    } catch (error) {
      console.error("Gemini API Error:", error);
      return "エラーが発生しました。しばらく待ってから再試行してください。";
    }
  };

  // --- AI Handlers ---
  const handleAIMotivation = async () => {
    if (!extra.motivation && !window.confirm("志望動機が空です。AIに一般的な例文を作成させますか？")) {
      return;
    }

    setAiModalTitle("AI志望動機作成・添削");
    setAiContent("");
    setIsAiLoading(true);
    setShowAIModal(true);

    const prompt = extra.motivation 
      ? `以下の文章（またはキーワード）をもとに、日本の履歴書に適した、熱意があり礼儀正しい「志望動機」をリライトしてください。\n\n元の文章：\n${extra.motivation}`
      : "事務職、または一般的な職種に応募するための、前向きで汎用性の高い志望動機の例文を作成してください。";

    const systemPrompt = "あなたはプロのキャリアアドバイザーです。ユーザーの入力を元に、採用担当者の心に響く履歴書の志望動機を作成してください。";

    const result = await callGeminiAPI(prompt, systemPrompt);
    setAiContent(result);
    setIsAiLoading(false);
  };

  const handleAIReview = async () => {
    setAiModalTitle("AI履歴書添削アドバイス");
    setAiContent("");
    setIsAiLoading(true);
    setShowAIModal(true);

    const resumeData = JSON.stringify({
      profile,
      educations: educations.filter(h => h.year || h.content),
      works: works.filter(h => h.year || h.content),
      licenses: licenses.filter(l => l.year || l.content),
      motivation: extra.motivation
    }, null, 2);

    const prompt = `以下の履歴書データを確認し、採用担当者の視点からフィードバックを行ってください。\n\n1. 全体的な印象\n2. 良い点（3つ）\n3. 改善すべき点や注意点（3つ）\n\nデータ：\n${resumeData}`;
    const systemPrompt = "あなたは厳しいけれど親切な採用担当者です。履歴書の内容を客観的に評価し、より良くするための具体的なアドバイスを日本語で提供してください。";

    const result = await callGeminiAPI(prompt, systemPrompt);
    setAiContent(result);
    setIsAiLoading(false);
  };

  const applyAiMotivation = () => {
    setExtra(prev => ({ ...prev, motivation: aiContent }));
    setShowAIModal(false);
  };

  // --- Handlers ---
  const handleProfileChange = (e) => {
    const { name, value } = e.target;
    setProfile(prev => ({ ...prev, [name]: value }));
  };

  const handleExtraChange = (e) => {
    const { name, value } = e.target;
    setExtra(prev => ({ ...prev, [name]: value }));
  };

  // Education Handlers
  const handleEducationChange = (id, field, value) => {
    setEducations(prev => prev.map(item => 
      item.id === id ? { ...item, [field]: value } : item
    ));
  };
  const addEducationRow = () => {
    setEducations(prev => [...prev, { id: Date.now(), year: '', month: '', content: '' }]);
  };
  const removeEducationRow = (id) => {
    setEducations(prev => prev.filter(item => item.id !== id));
  };

  // Work Handlers
  const handleWorkChange = (id, field, value) => {
    setWorks(prev => prev.map(item => 
      item.id === id ? { ...item, [field]: value } : item
    ));
  };
  const addWorkRow = () => {
    setWorks(prev => [...prev, { id: Date.now(), year: '', month: '', content: '' }]);
  };
  const removeWorkRow = (id) => {
    setWorks(prev => prev.filter(item => item.id !== id));
  };

  const handleLicenseChange = (id, field, value) => {
    setLicenses(prev => prev.map(item => 
      item.id === id ? { ...item, [field]: value } : item
    ));
  };
  const addLicenseRow = () => {
    setLicenses(prev => [...prev, { id: Date.now(), year: '', month: '', content: '' }]);
  };
  const removeLicenseRow = (id) => {
    setLicenses(prev => prev.filter(item => item.id !== id));
  };

  const loadSampleData = () => {
    setProfile({
      lastName: '山田', firstName: '太郎',
      lastNameKana: 'ヤマダ', firstNameKana: 'タロウ',
      birthdayYear: '1990', birthdayMonth: '5', birthdayDay: '15',
      age: '34', gender: '男',
      zip: '100-0001',
      address: '東京都千代田区千代田1-1',
      addressKana: 'トウキョウトチヨダクチヨダ',
      foreignAddress: '',
      phone: '090-1234-5678',
      email: 'taro.yamada@example.com',
      photo: null
    });
    setEducations([
      { id: 1, year: '2006', month: '4', content: '私立〇〇高等学校 入学' },
      { id: 2, year: '2009', month: '3', content: '私立〇〇高等学校 卒業' },
      { id: 3, year: '2009', month: '4', content: '〇〇大学 経済学部 入学' },
      { id: 4, year: '2013', month: '3', content: '〇〇大学 経済学部 卒業' },
    ]);
    setWorks([
      { id: 1, year: '2013', month: '4', content: '株式会社サンプル 入社' },
      { id: 2, year: '2013', month: '5', content: '営業部に配属' },
      { id: 3, year: '2020', month: '9', content: '一身上の都合により退職' },
    ]);
    setLicenses([
      { id: 1, year: '2011', month: '8', content: '普通自動車第一種運転免許 取得' },
      { id: 2, year: '2013', month: '2', content: '日商簿記検定2級 合格' },
    ]);
    setExtra({
      motivation: '貴社の「技術で世界を変える」という理念に強く共感し、これまでの営業経験を活かして貢献したいと考え志望いたしました。',
      commuteTime: '約 45 分',
      dependents: '1',
      spouse: '有',
      spouseSupport: '有'
    });
  };

  const handlePrint = () => {
    window.print();
  };

  const handleExportCSV = () => {
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "項目,内容\n";
    csvContent += `氏名,${profile.lastName} ${profile.firstName}\n`;
    csvContent += `フリガナ,${profile.lastNameKana} ${profile.firstNameKana}\n`;
    csvContent += `生年月日,${profile.birthdayYear}/${profile.birthdayMonth}/${profile.birthdayDay}\n`;
    csvContent += `住所,${profile.address}\n`;
    csvContent += `外国住所,${profile.foreignAddress}\n`;
    csvContent += `電話番号,${profile.phone}\n`;
    csvContent += `メール,${profile.email}\n`;
    
    csvContent += "\n年,月,学歴\n";
    educations.forEach(h => {
      if(h.content) csvContent += `${h.year},${h.month},${h.content}\n`;
    });

    csvContent += "\n年,月,職歴\n";
    works.forEach(h => {
      if(h.content) csvContent += `${h.year},${h.month},${h.content}\n`;
    });

    csvContent += "\n年,月,免許・資格\n";
    licenses.forEach(l => {
      if(l.content) csvContent += `${l.year},${l.month},${l.content}\n`;
    });

    csvContent += `\n志望動機,${extra.motivation.replace(/\n/g, ' ')}\n`;

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "履歴書データ.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // Helper to generate padded rows for fixed-layout
  const getPaddedRows = (items, minRows, showEndLabel = false) => {
    const rows = [...items.filter(i => i.year || i.month || i.content)];
    
    // Add "以上" row if needed and there's space
    if (showEndLabel && rows.length > 0) {
      rows.push({ isEndLabel: true, content: '以上' });
    }

    const currentLen = rows.length;
    if (currentLen < minRows) {
      for (let i = 0; i < minRows - currentLen; i++) {
        rows.push({ isEmpty: true });
      }
    }
    return rows;
  };

  // Define fixed row counts for layout
  const EDUCATION_ROWS = 8;
  const WORK_ROWS = 8;

  const paddedEducations = getPaddedRows(educations, EDUCATION_ROWS, false);
  const paddedWorks = getPaddedRows(works, WORK_ROWS, true);

  return (
    <div className="min-h-screen bg-gray-100 font-sans text-gray-800">
      
      {/* Header - No Print */}
      <header className="bg-blue-700 text-white p-4 shadow-md no-print sticky top-0 z-50">
        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
          <h1 className="text-xl font-bold flex items-center gap-2">
            <FileSpreadsheet className="w-6 h-6" />
            履歴書作成ダッシュボード
          </h1>
          <div className="flex flex-wrap gap-2 justify-center">
            <button onClick={handleAIReview} className="flex items-center gap-1 bg-purple-600 hover:bg-purple-500 px-3 py-1.5 rounded text-sm transition font-bold shadow-sm border border-purple-400">
              <Sparkles className="w-4 h-4 text-yellow-300" /> ✨ AI履歴書添削
            </button>
            <div className="w-px h-6 bg-blue-500 mx-1 hidden md:block"></div>
            <button onClick={loadSampleData} className="flex items-center gap-1 bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded text-sm transition">
              <RefreshCw className="w-4 h-4" /> サンプル読込
            </button>
            <button onClick={handleExportCSV} className="flex items-center gap-1 bg-green-600 hover:bg-green-500 px-3 py-1.5 rounded text-sm transition">
              <Download className="w-4 h-4" /> CSV出力
            </button>
            <button onClick={handlePrint} className="flex items-center gap-1 bg-white text-blue-800 hover:bg-gray-100 px-3 py-1.5 rounded text-sm font-bold transition">
              <Printer className="w-4 h-4" /> PDF保存 / 印刷
            </button>
          </div>
        </div>
      </header>

      {/* AI Modal */}
      {showAIModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center p-4 no-print">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
              <h2 className="text-lg font-bold flex items-center gap-2 text-purple-700">
                <Sparkles className="w-5 h-5" /> {aiModalTitle}
              </h2>
              <button onClick={() => setShowAIModal(false)} className="text-gray-500 hover:text-gray-700">
                <X className="w-6 h-6" />
              </button>
            </div>
            
            <div className="p-6 overflow-y-auto flex-1">
              {isAiLoading ? (
                <div className="flex flex-col items-center justify-center py-12 space-y-4">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
                  <p className="text-gray-600 animate-pulse">Gemini AIが思考中です...</p>
                </div>
              ) : (
                <div className="prose prose-sm max-w-none whitespace-pre-wrap bg-gray-50 p-4 rounded-md border text-gray-700">
                  {aiContent}
                </div>
              )}
            </div>

            <div className="p-4 border-t flex justify-end gap-2 bg-gray-50 rounded-b-lg">
              <button onClick={() => setShowAIModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded">
                閉じる
              </button>
              {aiModalTitle.includes('志望動機') && !isAiLoading && (
                <button 
                  onClick={applyAiMotivation} 
                  className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center gap-2"
                >
                  <CheckCircle2 className="w-4 h-4" /> 適用する
                </button>
              )}
            </div>
          </div>
        </div>
      )}

      <div className="max-w-7xl mx-auto p-4 flex flex-col lg:flex-row gap-6">
        
        {/* Input Sidebar - No Print */}
        <div className="w-full lg:w-1/3 bg-white p-4 rounded-lg shadow-md no-print h-fit overflow-y-auto max-h-[calc(100vh-100px)]">
          <div className="flex border-b mb-4">
            <button 
              className={`flex-1 py-2 text-sm font-medium ${activeTab === 'profile' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
              onClick={() => setActiveTab('profile')}
            >
              基本情報
            </button>
            <button 
              className={`flex-1 py-2 text-sm font-medium ${activeTab === 'history' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
              onClick={() => setActiveTab('history')}
            >
              経歴・資格
            </button>
            <button 
              className={`flex-1 py-2 text-sm font-medium ${activeTab === 'pr' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
              onClick={() => setActiveTab('pr')}
            >
              その他
            </button>
          </div>

          {activeTab === 'profile' && (
            <div className="space-y-4">
              {/* Photo Upload Section */}
              <div className="bg-blue-50 p-3 rounded border border-blue-100 mb-4">
                <label className="text-xs text-gray-500 block mb-2 font-bold">証明写真</label>
                <div className="flex items-center gap-3">
                  <div className="w-16 h-20 bg-gray-200 border border-gray-300 flex items-center justify-center overflow-hidden bg-white rounded-sm">
                    {profile.photo ? (
                      <img src={profile.photo} alt="Preview" className="w-full h-full object-cover" />
                    ) : (
                      <span className="text-xs text-gray-400 text-center">写真<br/>なし</span>
                    )}
                  </div>
                  <div className="flex flex-col gap-2">
                    <label className="cursor-pointer bg-white text-blue-600 px-3 py-1.5 rounded text-sm border border-blue-200 hover:bg-blue-50 transition flex items-center gap-1 shadow-sm">
                      <Upload size={14} /> 写真を選択
                      <input type="file" accept="image/*" onChange={handlePhotoUpload} className="hidden" />
                    </label>
                    {profile.photo && (
                      <button onClick={clearPhoto} className="text-red-500 text-xs hover:text-red-700 flex items-center gap-1 px-1">
                        <Trash2 size={12} /> 写真を削除
                      </button>
                    )}
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-2">
                <div>
                  <label className="text-xs text-gray-500 block">姓 (漢字)</label>
                  <input type="text" name="lastName" value={profile.lastName} onChange={handleProfileChange} className="w-full border rounded p-1.5" placeholder="山田" />
                </div>
                <div>
                  <label className="text-xs text-gray-500 block">名 (漢字)</label>
                  <input type="text" name="firstName" value={profile.firstName} onChange={handleProfileChange} className="w-full border rounded p-1.5" placeholder="太郎" />
                </div>
                <div>
                  <label className="text-xs text-gray-500 block">セイ (カナ)</label>
                  <input type="text" name="lastNameKana" value={profile.lastNameKana} onChange={handleProfileChange} className="w-full border rounded p-1.5" placeholder="ヤマダ" />
                </div>
                <div>
                  <label className="text-xs text-gray-500 block">メイ (カナ)</label>
                  <input type="text" name="firstNameKana" value={profile.firstNameKana} onChange={handleProfileChange} className="w-full border rounded p-1.5" placeholder="タロウ" />
                </div>
              </div>
              
              <div className="grid grid-cols-4 gap-2">
                <div className="col-span-2">
                  <label className="text-xs text-gray-500 block">生年月日 (年)</label>
                  <input type="number" name="birthdayYear" value={profile.birthdayYear} onChange={handleProfileChange} className="w-full border rounded p-1.5" placeholder="1990" />
                </div>
                <div>
                  <label className="text-xs text-gray-500 block">月</label>
                  <input type="number" name="birthdayMonth" value={profile.birthdayMonth} onChange={handleProfileChange} className="w-full border rounded p-1.5" placeholder="1" />
                </div>
                <div>
                  <label className="text-xs text-gray-500 block">日</label>
                  <input type="number" name="birthdayDay" value={profile.birthdayDay} onChange={handleProfileChange} className="w-full border rounded p-1.5" placeholder="1" />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-2">
                 <div>
                  <label className="text-xs text-gray-500 block">年齢</label>
                  <input type="number" name="age" value={profile.age} onChange={handleProfileChange} className="w-full border rounded p-1.5" placeholder="30" />
                </div>
                <div>
                  <label className="text-xs text-gray-500 block">性別</label>
                  <select name="gender" value={profile.gender} onChange={handleProfileChange} className="w-full border rounded p-1.5">
                    <option value="">選択</option>
                    <option value="男">男</option>
                    <option value="女">女</option>
                    <option value="その他">その他</option>
                  </select>
                </div>
              </div>

              <div>
                <label className="text-xs text-gray-500 block">郵便番号</label>
                <input type="text" name="zip" value={profile.zip} onChange={handleProfileChange} className="w-full border rounded p-1.5" placeholder="123-4567" />
              </div>
              <div>
                <label className="text-xs text-gray-500 block">現住所 (フリガナ)</label>
                <input type="text" name="addressKana" value={profile.addressKana} onChange={handleProfileChange} className="w-full border rounded p-1.5" placeholder="トウキョウト..." />
              </div>
              <div>
                <label className="text-xs text-gray-500 block">現住所</label>
                <textarea name="address" value={profile.address} onChange={handleProfileChange} className="w-full border rounded p-1.5 h-16" placeholder="東京都..." />
              </div>
              <div>
                <label className="text-xs text-gray-500 block">外国住所 (または緊急連絡先など)</label>
                <textarea name="foreignAddress" value={profile.foreignAddress} onChange={handleProfileChange} className="w-full border rounded p-1.5 h-16" placeholder="ベトナム ハノイ市..." />
              </div>
              <div>
                <label className="text-xs text-gray-500 block">電話番号</label>
                <input type="text" name="phone" value={profile.phone} onChange={handleProfileChange} className="w-full border rounded p-1.5" placeholder="090-1234-5678" />
              </div>
              <div>
                <label className="text-xs text-gray-500 block">メールアドレス</label>
                <input type="email" name="email" value={profile.email} onChange={handleProfileChange} className="w-full border rounded p-1.5" placeholder="example@gmail.com" />
              </div>
            </div>
          )}

          {activeTab === 'history' && (
            <div className="space-y-6">
              {/* 学歴 Section */}
              <div className="bg-gray-50 p-2 rounded">
                <h3 className="text-sm font-bold mb-2 flex justify-between items-center text-blue-800">
                  学歴
                  <button onClick={addEducationRow} className="text-blue-600 hover:bg-blue-100 p-1 rounded"><Plus size={16}/></button>
                </h3>
                {educations.map((item, index) => (
                  <div key={item.id} className="flex gap-2 mb-2 items-center">
                    <input 
                      type="text" 
                      placeholder="年"
                      value={item.year}
                      onChange={(e) => handleEducationChange(item.id, 'year', e.target.value)}
                      className="w-14 border rounded p-1.5 text-sm"
                    />
                    <input 
                      type="text" 
                      placeholder="月"
                      value={item.month}
                      onChange={(e) => handleEducationChange(item.id, 'month', e.target.value)}
                      className="w-10 border rounded p-1.5 text-sm"
                    />
                    <input 
                      type="text" 
                      placeholder="学歴内容 (例: 〇〇高校 卒業)"
                      value={item.content}
                      onChange={(e) => handleEducationChange(item.id, 'content', e.target.value)}
                      className="flex-1 border rounded p-1.5 text-sm"
                    />
                    <button onClick={() => removeEducationRow(item.id)} className="text-red-400 hover:text-red-600">
                      <Trash2 size={16} />
                    </button>
                  </div>
                ))}
              </div>

              {/* 職歴 Section */}
              <div className="bg-gray-50 p-2 rounded">
                <h3 className="text-sm font-bold mb-2 flex justify-between items-center text-blue-800">
                  職歴
                  <button onClick={addWorkRow} className="text-blue-600 hover:bg-blue-100 p-1 rounded"><Plus size={16}/></button>
                </h3>
                {works.map((item, index) => (
                  <div key={item.id} className="flex gap-2 mb-2 items-center">
                    <input 
                      type="text" 
                      placeholder="年"
                      value={item.year}
                      onChange={(e) => handleWorkChange(item.id, 'year', e.target.value)}
                      className="w-14 border rounded p-1.5 text-sm"
                    />
                    <input 
                      type="text" 
                      placeholder="月"
                      value={item.month}
                      onChange={(e) => handleWorkChange(item.id, 'month', e.target.value)}
                      className="w-10 border rounded p-1.5 text-sm"
                    />
                    <input 
                      type="text" 
                      placeholder="職歴内容 (例: 株式会社〇〇 入社)"
                      value={item.content}
                      onChange={(e) => handleWorkChange(item.id, 'content', e.target.value)}
                      className="flex-1 border rounded p-1.5 text-sm"
                    />
                    <button onClick={() => removeWorkRow(item.id)} className="text-red-400 hover:text-red-600">
                      <Trash2 size={16} />
                    </button>
                  </div>
                ))}
              </div>

              {/* 免許・資格 Section */}
              <div className="bg-gray-50 p-2 rounded">
                <h3 className="text-sm font-bold mb-2 flex justify-between items-center text-blue-800">
                  免許・資格
                  <button onClick={addLicenseRow} className="text-blue-600 hover:bg-blue-100 p-1 rounded"><Plus size={16}/></button>
                </h3>
                {licenses.map((item, index) => (
                  <div key={item.id} className="flex gap-2 mb-2 items-center">
                     <input 
                      type="text" 
                      placeholder="年"
                      value={item.year}
                      onChange={(e) => handleLicenseChange(item.id, 'year', e.target.value)}
                      className="w-14 border rounded p-1.5 text-sm"
                    />
                    <input 
                      type="text" 
                      placeholder="月"
                      value={item.month}
                      onChange={(e) => handleLicenseChange(item.id, 'month', e.target.value)}
                      className="w-10 border rounded p-1.5 text-sm"
                    />
                    <input 
                      type="text" 
                      placeholder="内容"
                      value={item.content}
                      onChange={(e) => handleLicenseChange(item.id, 'content', e.target.value)}
                      className="flex-1 border rounded p-1.5 text-sm"
                    />
                    <button onClick={() => removeLicenseRow(item.id)} className="text-red-400 hover:text-red-600">
                      <Trash2 size={16} />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}

          {activeTab === 'pr' && (
            <div className="space-y-4">
              <div>
                <label className="text-xs text-gray-500 block mb-1 flex justify-between items-center">
                  志望動機・特技・アピールポイント
                  <button 
                    onClick={handleAIMotivation}
                    className="text-purple-600 hover:text-purple-700 text-xs font-bold flex items-center gap-1 bg-purple-50 px-2 py-1 rounded border border-purple-200"
                  >
                    <Sparkles className="w-3 h-3" /> ✨ AIで生成/添削
                  </button>
                </label>
                <textarea 
                  name="motivation" 
                  value={extra.motivation} 
                  onChange={handleExtraChange} 
                  className="w-full border rounded p-2 h-40 text-sm" 
                  placeholder="志望動機などを入力してください。AI機能を使ってブラッシュアップも可能です。"
                />
              </div>
              <div className="grid grid-cols-2 gap-4">
                 <div>
                  <label className="text-xs text-gray-500 block mb-1">通勤時間</label>
                  <input type="text" name="commuteTime" value={extra.commuteTime} onChange={handleExtraChange} className="w-full border rounded p-1.5" placeholder="約 1 時間 00 分" />
                </div>
                <div>
                  <label className="text-xs text-gray-500 block mb-1">扶養家族数</label>
                  <input type="text" name="dependents" value={extra.dependents} onChange={handleExtraChange} className="w-full border rounded p-1.5" placeholder="0 人" />
                </div>
                 <div>
                  <label className="text-xs text-gray-500 block mb-1">配偶者</label>
                  <select name="spouse" value={extra.spouse} onChange={handleExtraChange} className="w-full border rounded p-1.5">
                    <option value="">選択</option>
                    <option value="有">有</option>
                    <option value="無">無</option>
                  </select>
                </div>
                 <div>
                  <label className="text-xs text-gray-500 block mb-1">配偶者の扶養義務</label>
                   <select name="spouseSupport" value={extra.spouseSupport} onChange={handleExtraChange} className="w-full border rounded p-1.5">
                    <option value="">選択</option>
                    <option value="有">有</option>
                    <option value="無">無</option>
                  </select>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Preview Area (Standard Resume Format) */}
        <div className="flex-1 bg-gray-500 p-4 rounded-lg overflow-auto flex flex-col items-center print:p-0 print:bg-white print:w-full print:block print:overflow-visible">
          
          {/* Print Action Bar (Added for ease of use) */}
          <div className="w-full max-w-[210mm] flex justify-between items-center mb-4 no-print text-white">
            <p className="text-sm opacity-80">※A4サイズで印刷されます</p>
            <button 
              onClick={handlePrint} 
              className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-500 transition font-bold"
            >
              <Printer className="w-5 h-5" /> 履歴書を印刷 / PDF保存
            </button>
          </div>

          {/* A4 Paper Container */}
          <div className="bg-white w-[210mm] min-h-[297mm] p-[10mm] shadow-lg text-black box-border print:shadow-none print:w-full print:h-auto print:p-0 text-[11px] leading-tight font-serif resume-sheet">
            
            {/* Title */}
            <div className="flex justify-between items-end mb-4 border-b-2 border-black pb-1">
              <h1 className="text-2xl font-bold tracking-[1em]">履歴書</h1>
              <p className="text-xs mb-1">{new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })} 現在</p>
            </div>

            {/* Profile Section */}
            <table className="w-full border-collapse border border-black mb-4">
              <tbody>
                <tr className="border-b border-black border-dashed">
                  <td className="p-1 w-[10%] text-xs align-top border-r border-black">ふりがな</td>
                  <td className="p-1 w-[60%] align-bottom border-r border-black">{profile.lastNameKana} {profile.firstNameKana}</td>
                  <td className="w-[30%] border-l border-black p-2 text-center text-gray-400 text-xs align-middle" rowSpan="3">
                    <div className="h-[36mm] w-[26mm] mx-auto border border-gray-300 flex items-center justify-center bg-gray-50 overflow-hidden relative">
                      {profile.photo ? (
                        <img src={profile.photo} alt="証明写真" className="w-full h-full object-cover" />
                      ) : (
                        <div className="whitespace-pre-wrap">
                          {'写真を貼る位置\n(縦 36-40mm)\n(横 24-30mm)'}
                        </div>
                      )}
                    </div>
                  </td>
                </tr>
                <tr className="border-b border-black">
                  <td className="p-2 text-xs border-r border-black">氏　名</td>
                  <td className="p-2 text-xl font-bold border-r border-black h-16 align-middle">
                    {profile.lastName} &nbsp;&nbsp; {profile.firstName}
                  </td>
                </tr>
                <tr className="border-b border-black">
                  <td colSpan="2" className="p-2 border-r border-black">
                    {profile.birthdayYear}年 {profile.birthdayMonth}月 {profile.birthdayDay}日生 
                    （満 {profile.age} 歳） {profile.gender}
                  </td>
                </tr>
              </tbody>
            </table>

            <table className="w-full border-collapse border border-black mb-6">
              <tbody>
                 <tr className="border-b border-black border-dashed">
                  <td className="p-1 w-[10%] text-xs border-r border-black">ふりがな</td>
                  <td className="p-1 align-bottom">{profile.addressKana}</td>
                </tr>
                <tr className="border-b border-black">
                  <td className="p-2 text-xs border-r border-black align-middle">現住所</td>
                  <td className="p-2 align-middle">
                    <div>〒 {profile.zip}</div>
                    <div>{profile.address}</div>
                  </td>
                </tr>
                <tr className="border-b border-black">
                  <td className="p-2 text-xs border-r border-black align-middle">連絡先<br/>(外国住所など)</td>
                  <td className="p-2 align-middle whitespace-pre-wrap text-sm">
                    {profile.foreignAddress}
                  </td>
                </tr>
                <tr className="border-b border-black">
                   <td className="p-2 text-xs border-r border-black align-middle">電話</td>
                   <td className="p-2 align-middle">{profile.phone}</td>
                </tr>
                 <tr className="">
                   <td className="p-2 text-xs border-r border-black align-middle">Email</td>
                   <td className="p-2 align-middle">{profile.email}</td>
                </tr>
              </tbody>
            </table>

            {/* History Section (Split into Education and Work) */}
            
            {/* Education Table */}
            <table className="w-full border-collapse border border-black mb-1 text-sm border-b-0">
              <thead>
                <tr className="bg-gray-100 border-b border-black h-6">
                  <th className="w-[10%] border-r border-black font-normal text-xs">年</th>
                  <th className="w-[7%] border-r border-black font-normal text-xs">月</th>
                  <th className="font-normal text-xs">学歴</th>
                </tr>
              </thead>
              <tbody>
                {paddedEducations.map((row, i) => (
                  <tr key={i} className="h-7 border-b border-black border-dotted last:border-b-2 last:border-solid">
                    <td className="border-r border-black text-center">{row.year || ''}</td>
                    <td className="border-r border-black text-center">{row.month || ''}</td>
                    <td className="px-2 align-middle">
                      {row.content}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>

            {/* Work Table */}
            <table className="w-full border-collapse border border-black mb-6 text-sm">
              <thead>
                <tr className="bg-gray-100 border-b border-black h-6">
                  <th className="w-[10%] border-r border-black font-normal text-xs">年</th>
                  <th className="w-[7%] border-r border-black font-normal text-xs">月</th>
                  <th className="font-normal text-xs">職歴</th>
                </tr>
              </thead>
              <tbody>
                {paddedWorks.map((row, i) => (
                  <tr key={i} className="h-7 border-b border-black border-dotted last:border-b-2 last:border-solid">
                    <td className="border-r border-black text-center">{row.year || ''}</td>
                    <td className="border-r border-black text-center">{row.month || ''}</td>
                    <td className="px-2 align-middle">
                       {row.isEndLabel ? (
                        <div className="text-right mr-4">{row.content}</div>
                       ) : (
                        row.content
                       )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>

            {/* License Section */}
            <table className="w-full border-collapse border border-black mb-6 text-sm">
               <thead>
                <tr className="bg-gray-100 border-b border-black h-6">
                  <th className="w-[10%] border-r border-black font-normal text-xs">年</th>
                  <th className="w-[7%] border-r border-black font-normal text-xs">月</th>
                  <th className="font-normal text-xs">免許・資格</th>
                </tr>
              </thead>
              <tbody>
                {[...Array(6)].map((_, i) => {
                  const item = licenses[i];
                  return (
                    <tr key={i} className="h-7 border-b border-black border-dotted last:border-b-2 last:border-solid">
                      <td className="border-r border-black text-center">{item?.year}</td>
                      <td className="border-r border-black text-center">{item?.month}</td>
                      <td className="px-2">{item?.content}</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>

            {/* Motivation Section */}
             <table className="w-full border-collapse border border-black mb-6">
              <tbody>
                <tr className="h-32">
                  <td className="p-2 align-top">
                    <div className="text-xs mb-1 font-bold">志望の動機、特技、好きな学科、アピールポイントなど</div>
                    <div className="whitespace-pre-wrap leading-relaxed">{extra.motivation}</div>
                  </td>
                </tr>
              </tbody>
            </table>

            {/* Footer Section */}
            <table className="w-full border-collapse border border-black">
              <tbody>
                <tr>
                   <td className="w-[50%] border-r border-black p-0 align-top">
                     <div className="p-2 border-b border-black border-dotted h-16">
                       <div className="text-xs font-bold">本人希望記入欄（特に給料・職種・勤務時間・勤務地・その他についての希望などがあれば記入）</div>
                     </div>
                      <div className="p-2">
                        <div className="text-xs font-bold mb-1">通勤時間</div>
                        <div>{extra.commuteTime}</div>
                      </div>
                   </td>
                   <td className="w-[50%] p-2 align-top">
                     <div className="grid grid-cols-2 gap-y-4 pt-2">
                        <div>
                          <div className="text-xs font-bold">扶養家族数（配偶者を除く）</div>
                          <div className="mt-1">{extra.dependents}</div>
                        </div>
                         <div>
                          <div className="text-xs font-bold">配偶者</div>
                          <div className="mt-1">{extra.spouse}</div>
                        </div>
                         <div>
                          <div className="text-xs font-bold">配偶者の扶養義務</div>
                          <div className="mt-1">{extra.spouseSupport}</div>
                        </div>
                     </div>
                   </td>
                </tr>
              </tbody>
            </table>

          </div>
        </div>
      </div>

      <style>{`
        @media print {
          @page { margin: 0; size: auto; }
          body { background: white; -webkit-print-color-adjust: exact; }
          .no-print { display: none !important; }
          .resume-sheet { width: 100% !important; box-shadow: none !important; margin: 0 !important; padding: 10mm !important; }
        }
      `}</style>
    </div>
  );
};

export default ResumeDashboard;